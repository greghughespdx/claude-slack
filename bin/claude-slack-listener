#!/bin/bash

# Claude-Slack Reliable Startup Script
# Ensures slack_listener.py starts cleanly with proper environment

set -e

# Get the script directory
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
INTEGRATION_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
CORE_DIR="$INTEGRATION_DIR/core"

# Load environment variables from .env file
ENV_FILE="${INTEGRATION_DIR}/.env"
if [ -f "$ENV_FILE" ]; then
    set -a
    source "$ENV_FILE"
    set +a
fi

# Environment variables for paths (with defaults)
SLACK_LOG_DIR=${SLACK_LOG_DIR:-"$HOME/.claude/slack/logs"}
SLACK_SOCKET_DIR=${SLACK_SOCKET_DIR:-"$HOME/.claude/slack/sockets"}

# Create required directories
mkdir -p "$SLACK_LOG_DIR"
mkdir -p "$SLACK_SOCKET_DIR"

LOG_FILE="$SLACK_LOG_DIR/slack_listener_startup.log"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging function
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

echo "=======================================" | tee "$LOG_FILE"
echo "Claude-Slack Listener Startup" | tee -a "$LOG_FILE"
echo "$(date '+%Y-%m-%d %H:%M:%S')" | tee -a "$LOG_FILE"
echo "=======================================" | tee -a "$LOG_FILE"
echo ""

# Step 1: Kill any existing slack_listener processes
log "Step 1: Checking for existing processes..."
EXISTING_PIDS=$(pgrep -f "slack_listener.py" 2>/dev/null || true)
if [ -n "$EXISTING_PIDS" ]; then
    echo -e "${YELLOW}Found existing slack_listener.py processes:${NC}"
    for PID in $EXISTING_PIDS; do
        echo "  - PID $PID"
    done
    log "Killing existing processes: $EXISTING_PIDS"
    pkill -f "slack_listener.py" 2>/dev/null || true
    sleep 2
    echo -e "${GREEN}✓ Existing processes terminated${NC}"
else
    echo -e "${GREEN}✓ No existing processes found${NC}"
fi

# Step 2: Validate environment
log "Step 2: Validating environment..."

# Check .env file exists (look in integration dir, not core)
ENV_FILE="${INTEGRATION_DIR}/.env"
if [ ! -f "$ENV_FILE" ]; then
    echo -e "${RED}✗ Error: .env file not found at $ENV_FILE${NC}"
    echo "  Please create the .env file with your Slack tokens"
    echo "  Example:"
    echo "    SLACK_BOT_TOKEN=xoxb-..."
    echo "    SLACK_APP_TOKEN=xapp-..."
    log "ERROR: .env file not found"
    exit 1
fi

# Check required tokens are present
MISSING_VARS=""
if ! grep -q "SLACK_BOT_TOKEN=" "$ENV_FILE"; then
    MISSING_VARS="SLACK_BOT_TOKEN"
fi
if ! grep -q "SLACK_APP_TOKEN=" "$ENV_FILE"; then
    if [ -n "$MISSING_VARS" ]; then
        MISSING_VARS="$MISSING_VARS, SLACK_APP_TOKEN"
    else
        MISSING_VARS="SLACK_APP_TOKEN"
    fi
fi

if [ -n "$MISSING_VARS" ]; then
    echo -e "${RED}✗ Error: Missing required environment variables: $MISSING_VARS${NC}"
    log "ERROR: Missing environment variables: $MISSING_VARS"
    exit 1
fi

echo -e "${GREEN}✓ Environment validated${NC}"
log "Environment validation successful"

# Step 3: Directories already created at top of script
log "Step 3: Directories already ready"
echo -e "${GREEN}✓ Directories ready${NC}"

# Step 4: Start slack_listener.py
log "Step 4: Starting slack_listener.py..."
echo -e "${BLUE}Starting slack_listener.py...${NC}"

# Clear old log files to avoid confusion
LISTENER_LOG="$SLACK_LOG_DIR/slack_listener.log"
> "$LISTENER_LOG" 2>/dev/null || true

# Monitor expects logs at /tmp/slack_listener.log (for event starvation detection)
MONITOR_LOG="/tmp/slack_listener.log"
> "$MONITOR_LOG" 2>/dev/null || true

# Start the listener in the background
# NOTE: Removed 'nohup' - it was interfering with Socket Mode WebSocket connections
# Using 'tee' to write to both startup log and monitor log (monitor watches /tmp/slack_listener.log)
cd "$CORE_DIR"
VENV_PYTHON="${INTEGRATION_DIR}/.venv/bin/python3"
if [ -x "$VENV_PYTHON" ]; then
    "$VENV_PYTHON" -u slack_listener.py 2>&1 | tee "$MONITOR_LOG" > "$LISTENER_LOG" &
else
    python3 -u slack_listener.py 2>&1 | tee "$MONITOR_LOG" > "$LISTENER_LOG" &
fi
NEW_PID=$!

log "Started slack_listener.py with PID $NEW_PID"
echo "  PID: $NEW_PID"

# Step 5: Wait for initialization
echo -n "  Waiting for Socket Mode to initialize"
for i in {1..10}; do
    echo -n "."
    sleep 1

    # Check if process is still running
    if ! kill -0 $NEW_PID 2>/dev/null; then
        echo ""
        echo -e "${RED}✗ Process died during initialization${NC}"
        echo "  Check logs at: $LISTENER_LOG"
        if [ -f "$LISTENER_LOG" ]; then
            echo "  Last log lines:"
            tail -5 "$LISTENER_LOG" 2>/dev/null
        fi
        log "ERROR: Process died during initialization"
        exit 1
    fi

    # Check if Socket Mode is connected (look for "Bolt app is running" in log)
    # Check monitor log since that's where output is being written
    if [ -f "$MONITOR_LOG" ] && grep -q "Bolt app is running" "$MONITOR_LOG"; then
        echo ""
        echo -e "${GREEN}✓ Socket Mode connected${NC}"
        break
    fi

    if [ $i -eq 10 ]; then
        echo ""
        echo -e "${YELLOW}⚠ Socket Mode may not be fully initialized${NC}"
        echo "  Process is running but connection status unclear"
        log "WARNING: Socket Mode initialization timeout"
    fi
done

# Step 6: Run health check
log "Step 5: Running health check..."
echo ""
echo "Running health check..."
if "${SCRIPT_DIR}/claude-slack-health"; then
    echo ""
    echo -e "${GREEN}========================================${NC}"
    echo -e "${GREEN}✅ STARTUP SUCCESSFUL${NC}"
    echo -e "${GREEN}========================================${NC}"
    log "Startup successful - health check passed"
else
    echo ""
    echo -e "${YELLOW}========================================${NC}"
    echo -e "${YELLOW}⚠️  STARTUP COMPLETED WITH WARNINGS${NC}"
    echo -e "${YELLOW}========================================${NC}"
    echo "The listener is running but some checks failed."
    echo "This may be normal if no messages have been processed yet."
    log "Startup completed with warnings from health check"
fi

echo ""
echo "Listener PID: $NEW_PID"
echo "Log file (startup): $LISTENER_LOG"
echo "Log file (monitor): $MONITOR_LOG"
echo ""
echo "To stop the listener: pkill -f slack_listener.py"
echo "To check status: claude-slack-health"
echo "To start monitor: claude-slack-monitor"

log "Startup script completed"