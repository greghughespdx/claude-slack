#!/bin/bash

# Claude-Slack Launcher with Auto-Recovery
# Ensures Slack listener is ready before starting Claude session
# Installs Slack hooks in project directory if not present

set -e

# Get the script directory
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
INTEGRATION_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
CORE_DIR="$INTEGRATION_DIR/core"
HOOKS_TEMPLATE_DIR="$INTEGRATION_DIR/hooks"

# Detect project directory (current working directory)
PROJECT_DIR="$(pwd)"
PROJECT_HOOKS_DIR="$PROJECT_DIR/.claude/hooks"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Step 1: Ensure listener is ready
echo -e "${BLUE}Checking Slack integration...${NC}"
if ! "${SCRIPT_DIR}/claude-slack-ensure"; then
    echo -e "${RED}✗ Failed to initialize Slack listener${NC}"
    echo "Please check your .env configuration and try again."
    exit 1
fi

# Step 2: Install Slack configuration in project directory (if needed)
echo -e "${BLUE}Checking Slack configuration in project...${NC}"

# Step 2a: Ensure .claude/ is in .gitignore (prevent stash conflicts)
PROJECT_GITIGNORE="$PROJECT_DIR/.gitignore"
if [ -f "$PROJECT_GITIGNORE" ]; then
    if ! grep -q "^\.claude/" "$PROJECT_GITIGNORE" && ! grep -q "^\.claude$" "$PROJECT_GITIGNORE"; then
        echo -e "${YELLOW}Adding .claude/ to .gitignore...${NC}"
        echo "" >> "$PROJECT_GITIGNORE"
        echo "# Claude Code local configuration (auto-managed by claude-slack)" >> "$PROJECT_GITIGNORE"
        echo ".claude/" >> "$PROJECT_GITIGNORE"
        echo -e "${GREEN}  ✓ .claude/ added to .gitignore${NC}"
    else
        echo -e "${GREEN}  ✓ .claude/ already in .gitignore${NC}"
    fi
else
    # No .gitignore exists, create one with .claude/
    echo -e "${YELLOW}Creating .gitignore with .claude/...${NC}"
    echo "# Claude Code local configuration (auto-managed by claude-slack)" > "$PROJECT_GITIGNORE"
    echo ".claude/" >> "$PROJECT_GITIGNORE"
    echo -e "${GREEN}  ✓ .gitignore created${NC}"
fi

# Create .claude directory if it doesn't exist
PROJECT_CLAUDE_DIR="$PROJECT_DIR/.claude"
if [ ! -d "$PROJECT_CLAUDE_DIR" ]; then
    echo -e "${YELLOW}Creating .claude directory...${NC}"
    mkdir -p "$PROJECT_CLAUDE_DIR"
fi

# Create hooks directory if it doesn't exist
if [ ! -d "$PROJECT_HOOKS_DIR" ]; then
    echo -e "${YELLOW}Creating .claude/hooks directory...${NC}"
    mkdir -p "$PROJECT_HOOKS_DIR"
fi

# Step 2a: Check and install settings.local.json
PROJECT_SETTINGS="$PROJECT_CLAUDE_DIR/settings.local.json"
TEMPLATE_SETTINGS="$HOOKS_TEMPLATE_DIR/settings.local.json.template"
SETTINGS_NEEDS_UPDATE=false

if [ ! -f "$PROJECT_SETTINGS" ]; then
    echo -e "${YELLOW}  Installing settings.local.json...${NC}"
    cp "$TEMPLATE_SETTINGS" "$PROJECT_SETTINGS"
    echo -e "${GREEN}  ✓ settings.local.json installed${NC}"
else
    # Check if settings file has the required sections
    if ! grep -q '"hooks"' "$PROJECT_SETTINGS" || ! grep -q '"permissions"' "$PROJECT_SETTINGS"; then
        echo -e "${YELLOW}  Updating settings.local.json (missing hooks or permissions)...${NC}"
        # Backup existing settings
        cp "$PROJECT_SETTINGS" "$PROJECT_SETTINGS.backup"
        cp "$TEMPLATE_SETTINGS" "$PROJECT_SETTINGS"
        echo -e "${GREEN}  ✓ settings.local.json updated (backup saved)${NC}"
    else
        echo -e "${GREEN}  ✓ settings.local.json already configured${NC}"
    fi
fi

# Step 2b: Install hook files
HOOKS_TO_INSTALL=(
    "on_stop.py"
    "on_notification.py"
    "on_pretooluse.py"
)

# Check and install/update each hook
HOOKS_INSTALLED=0
HOOKS_UPDATED=0
for hook in "${HOOKS_TO_INSTALL[@]}"; do
    TEMPLATE_HOOK="$HOOKS_TEMPLATE_DIR/$hook"
    PROJECT_HOOK="$PROJECT_HOOKS_DIR/$hook"

    if [ ! -f "$PROJECT_HOOK" ]; then
        # Hook doesn't exist, copy from template
        echo -e "${YELLOW}  Installing $hook...${NC}"
        cp "$TEMPLATE_HOOK" "$PROJECT_HOOK"
        chmod +x "$PROJECT_HOOK"
        HOOKS_INSTALLED=$((HOOKS_INSTALLED + 1))
    else
        # Hook exists, check version
        TEMPLATE_VERSION=$(grep -E '^HOOK_VERSION = |^Version: ' "$TEMPLATE_HOOK" 2>/dev/null | head -1 | sed -E 's/.*"([0-9.]+)".*/\1/; s/.*Version: ([0-9.]+).*/\1/')
        PROJECT_VERSION=$(grep -E '^HOOK_VERSION = |^Version: ' "$PROJECT_HOOK" 2>/dev/null | head -1 | sed -E 's/.*"([0-9.]+)".*/\1/; s/.*Version: ([0-9.]+).*/\1/')

        if [ -n "$TEMPLATE_VERSION" ] && [ -n "$PROJECT_VERSION" ] && [ "$TEMPLATE_VERSION" != "$PROJECT_VERSION" ]; then
            echo -e "${YELLOW}  Updating $hook from v${PROJECT_VERSION} to v${TEMPLATE_VERSION}...${NC}"
            cp "$TEMPLATE_HOOK" "$PROJECT_HOOK"
            chmod +x "$PROJECT_HOOK"
            HOOKS_UPDATED=$((HOOKS_UPDATED + 1))
        elif [ -n "$PROJECT_VERSION" ]; then
            echo -e "${GREEN}  ✓ $hook v${PROJECT_VERSION} is current${NC}"
        else
            # No version found, update to get versioned hook
            echo -e "${YELLOW}  Updating $hook to versioned copy...${NC}"
            cp "$TEMPLATE_HOOK" "$PROJECT_HOOK"
            chmod +x "$PROJECT_HOOK"
            HOOKS_UPDATED=$((HOOKS_UPDATED + 1))
        fi
    fi
done

if [ $HOOKS_INSTALLED -gt 0 ]; then
    echo -e "${GREEN}Installed $HOOKS_INSTALLED new hook file(s)${NC}"
fi
if [ $HOOKS_UPDATED -gt 0 ]; then
    echo -e "${GREEN}Updated $HOOKS_UPDATED hook file(s)${NC}"
fi

# Step 3: Wait a bit for full stabilization
echo -e "${BLUE}Waiting for services to stabilize...${NC}"
sleep 2

# Step 4: Launch Claude with the hybrid wrapper
echo -e "${GREEN}Starting Claude with Slack integration...${NC}"
echo ""

# Pass all arguments through to the Python wrapper (use venv if available)
cd "$PROJECT_DIR"
VENV_PYTHON="${INTEGRATION_DIR}/.venv/bin/python3"
if [ -x "$VENV_PYTHON" ]; then
    exec "$VENV_PYTHON" "$CORE_DIR/claude_wrapper_hybrid.py" "$@"
else
    exec python3 "$CORE_DIR/claude_wrapper_hybrid.py" "$@"
fi
