#!/bin/bash
#
# Start Session Registry Service
#
# This service manages multiple concurrent Claude Code sessions
# in Phase 2.5 multi-session mode.
#
# Usage:
#   ./start-registry
#
# Press Ctrl+C to stop the service.
#

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
INTEGRATION_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
CORE_DIR="$INTEGRATION_DIR/core"

# Load environment variables from .env file
ENV_FILE="$INTEGRATION_DIR/.env"
if [ -f "$ENV_FILE" ]; then
    # Export variables from .env (skip comments and empty lines)
    set -a
    source "$ENV_FILE"
    set +a
fi

# Environment variables (with defaults)
SLACK_SOCKET_DIR=${SLACK_SOCKET_DIR:-"$HOME/.claude/slack/sockets"}
REGISTRY_DB_PATH=${REGISTRY_DB_PATH:-"$HOME/.claude/slack/registry.db"}

# Create required directories
mkdir -p "$SLACK_SOCKET_DIR"
mkdir -p "$(dirname "$REGISTRY_DB_PATH")"

REGISTRY_PY="$CORE_DIR/session_registry.py"

# Check if registry script exists
if [ ! -f "$REGISTRY_PY" ]; then
    echo "‚ùå Error: session_registry.py not found at $REGISTRY_PY"
    echo "   Make sure you have Phase 2.5 files installed"
    exit 1
fi

# Check if Python 3 is available
if ! command -v python3 &> /dev/null; then
    echo "‚ùå Error: python3 not found"
    echo "   Install Python 3.8 or higher"
    exit 1
fi

# Display startup info
echo "=========================================="
echo "  Session Registry Service (Phase 2.5)"
echo "=========================================="
echo ""
echo "üöÄ Starting Session Registry..."
echo ""
echo "üì° Socket: $SLACK_SOCKET_DIR/registry.sock"
echo "üìÅ Data:   $REGISTRY_DB_PATH"
echo ""
echo "   Press Ctrl+C to stop"
echo ""

# Run registry service (use venv if available)
VENV_PYTHON="${INTEGRATION_DIR}/.venv/bin/python3"
if [ -x "$VENV_PYTHON" ]; then
    exec "$VENV_PYTHON" "$REGISTRY_PY"
else
    exec python3 "$REGISTRY_PY"
fi
