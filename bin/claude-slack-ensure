#!/bin/bash

# Claude-Slack Ensure Listener Ready Script
# Ensures slack_listener is running and healthy before starting Claude
# Returns 0 if ready, 1 if failed

set -e

# Get the script directory
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
INTEGRATION_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
CORE_DIR="$INTEGRATION_DIR/core"

# Load environment variables from .env file
ENV_FILE="$INTEGRATION_DIR/.env"
if [ -f "$ENV_FILE" ]; then
    # Export variables from .env (skip comments and empty lines)
    set -a
    source "$ENV_FILE"
    set +a
fi

# Environment variables (with defaults)
SLACK_LOG_DIR=${SLACK_LOG_DIR:-"$HOME/.claude/slack/logs"}

# Create required directories
mkdir -p "$SLACK_LOG_DIR"

# Colors for output (only if interactive)
if [ -t 1 ]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    NC='\033[0m' # No Color
else
    RED=''
    GREEN=''
    YELLOW=''
    NC=''
fi

# Logging function
log() {
    if [ -t 1 ]; then
        echo "$1"
    fi
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$SLACK_LOG_DIR/ensure_listener.log"
}

log "Ensuring Slack listener is ready..."

# Step 0: Kill any duplicate session_registry processes
# Multiple registries cause socket binding conflicts
REGISTRY_PIDS=$(pgrep -f "session_registry.py" 2>/dev/null || true)
if [ -n "$REGISTRY_PIDS" ]; then
    REGISTRY_COUNT=$(echo "$REGISTRY_PIDS" | wc -l | tr -d ' ')
    if [ "$REGISTRY_COUNT" -gt 1 ]; then
        log "Found $REGISTRY_COUNT registry processes, killing duplicates..."
        pkill -9 -f "session_registry.py" 2>/dev/null || true
        sleep 1
        log "✓ Cleaned up duplicate registry processes"
    fi
fi

# Step 0.5: Ensure session registry is running
log "Checking session registry..."
SOCKET_DIR=${SLACK_SOCKET_DIR:-"$HOME/.claude/slack/sockets"}
REGISTRY_SOCKET="$SOCKET_DIR/registry.sock"

# Check if registry is healthy (both process running AND socket exists)
REGISTRY_RUNNING=false
if pgrep -f "session_registry.py" > /dev/null && [ -S "$REGISTRY_SOCKET" ]; then
    REGISTRY_RUNNING=true
    log "✓ Registry already running and healthy"
    echo -e "${GREEN}✓ Session registry is ready${NC}"
fi

# If registry not healthy, start it
if [ "$REGISTRY_RUNNING" = false ]; then
    log "Registry not healthy, starting..."
    echo -e "${YELLOW}Starting session registry...${NC}"

    # Kill any existing registry processes
    pkill -9 -f "session_registry.py" 2>/dev/null || true
    sleep 1

    # Check if registry script exists
    if [ ! -f "${SCRIPT_DIR}/claude-slack-registry" ]; then
        echo -e "${RED}✗ Error: claude-slack-registry not found${NC}"
        exit 1
    fi

    # Start the registry in background
    "${SCRIPT_DIR}/claude-slack-registry" > /dev/null 2>&1 &
    REGISTRY_PID=$!
    log "Started registry with PID $REGISTRY_PID"

    # Wait for registry socket to be created (max 10 seconds)
    REGISTRY_TIMEOUT=10
    REGISTRY_WAIT=0
    while [ $REGISTRY_WAIT -lt $REGISTRY_TIMEOUT ]; do
        if [ -S "$REGISTRY_SOCKET" ]; then
            log "✓ Registry socket created: $REGISTRY_SOCKET"
            echo -e "${GREEN}✓ Session registry started${NC}"
            break
        fi
        sleep 1
        REGISTRY_WAIT=$((REGISTRY_WAIT + 1))
    done

    # Verify socket was created
    if [ ! -S "$REGISTRY_SOCKET" ]; then
        echo -e "${RED}✗ Registry socket not created after ${REGISTRY_TIMEOUT}s${NC}"
        log "✗ Registry socket not created: $REGISTRY_SOCKET"
        exit 1
    fi
fi

# Step 1: Check if listener is already running and healthy
# If managed by launchd, we don't want to kill it
log "Checking Slack listener status..."

LISTENER_HEALTHY=false
if pgrep -f "slack_listener.py" > /dev/null; then
    # Process exists, check if it's responding (look for recent log activity or just trust it)
    log "Listener process found, checking health..."
    if [ -f "${SCRIPT_DIR}/claude-slack-health" ] && "${SCRIPT_DIR}/claude-slack-health" >/dev/null 2>&1; then
        LISTENER_HEALTHY=true
        log "✓ Listener already running and healthy"
        echo -e "${GREEN}✓ Slack listener already running${NC}"
    fi
fi

# Step 2: Only start listener if not healthy
if [ "$LISTENER_HEALTHY" = false ]; then
    log "Listener not healthy, starting..."
    echo -e "${YELLOW}Starting Slack listener...${NC}"

    # Kill any existing unhealthy listener processes
    pkill -9 -f "slack_listener.py" 2>/dev/null || true
    sleep 2

    # Check if start script exists
    if [ ! -f "${SCRIPT_DIR}/claude-slack-listener" ]; then
        echo -e "${RED}✗ Error: claude-slack-listener not found${NC}"
        exit 1
    fi

    # Run the startup script
    if ! "${SCRIPT_DIR}/claude-slack-listener"; then
        echo -e "${RED}✗ Failed to start Slack listener${NC}"
        log "✗ Failed to start Slack listener"
        exit 1
    fi

    log "✓ Successfully started Slack listener"
fi

# Step 3: Wait for initialization
log "Waiting for initialization..."
sleep 3

# Step 4: Verify health
if [ ! -f "${SCRIPT_DIR}/claude-slack-health" ]; then
    echo -e "${RED}✗ Error: claude-slack-health not found${NC}"
    exit 1
fi

# Run health check with retries
MAX_HEALTH_ATTEMPTS=5
HEALTH_ATTEMPT=1

while [ $HEALTH_ATTEMPT -le $MAX_HEALTH_ATTEMPTS ]; do
    if "${SCRIPT_DIR}/claude-slack-health" >/dev/null 2>&1; then
        echo -e "${GREEN}✓ Slack listener is healthy${NC}"
        log "✓ Health check passed on attempt $HEALTH_ATTEMPT"
        break
    fi

    if [ $HEALTH_ATTEMPT -lt $MAX_HEALTH_ATTEMPTS ]; then
        log "Health check attempt $HEALTH_ATTEMPT failed, retrying..."
        sleep 2
    fi

    HEALTH_ATTEMPT=$((HEALTH_ATTEMPT + 1))
done

# Final health check
if ! "${SCRIPT_DIR}/claude-slack-health" >/dev/null 2>&1; then
    echo -e "${RED}✗ Slack listener failed health check after $MAX_HEALTH_ATTEMPTS attempts${NC}"
    log "✗ Failed health check after $MAX_HEALTH_ATTEMPTS attempts"
    exit 1
fi

# Step 5: Ensure monitor is running
if ! pgrep -f "claude-slack-monitor" > /dev/null; then
    log "Monitor not running, starting it..."
    echo -e "${YELLOW}Starting Socket Mode monitor...${NC}"
    "${SCRIPT_DIR}/claude-slack-monitor" > /dev/null 2>&1 &
    MONITOR_PID=$!
    log "✓ Started monitor with PID $MONITOR_PID"
    echo -e "${GREEN}✓ Monitor started (PID: $MONITOR_PID)${NC}"
else
    log "✓ Monitor already running"
    echo -e "${GREEN}✓ Monitor already running${NC}"
fi

log "✓ Slack integration fully initialized"
exit 0